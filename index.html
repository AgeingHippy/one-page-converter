<!DOCTYPE html>
<html>
  <head>
    <title>My Converter</title>
    <link rel="stylesheet" href="style.css" />
    <script src="script.js"></script>
    <script src="initialiseSession.js"></script>
  </head>
  <body>
    <div id="main-div" class="container">
      <div id="content-div" class="float-primary">
        <h1 id="unit-header">UNITS HEADER</h1>
        <br />
        <h2 id="conversion-header">Conversion Text</h2>
        <table>
          <tr>
            <th id="th-from">Source Unit</th>
            <th id="th-switch"></th>
            <th id="th-to">Target Unit</th>
          </tr>
          <tr>
            <td id="td-from">
              <input
                type="text"
                id="convert-from"
                data-conversion-function="tempFToC"
              />
            </td>
            <td id="td-switch">
              <button type="button">&lt;=switch=&gt;</button>
            </td>
            <td id="td-to">
              <input type="text" id="convert-to" disabled />
            </td>
          </tr>
        </table>
        <br />
        <div id="formula">formula here</div>
      </div>

      <div id="sidebar-div" class="float-sidebar">
        <ul id="conversion-selector-list">
        </ul>
      </div>
    </div>

    <script>
      //build selections list
      {
        debugger;
        let functionMap = new Map(Object.entries(JSON.parse(sessionStorage.getItem("functionMap"))));
        buildConversionSelectionHTML(functionMap);
      }
      

      //Show relevant lists and collapse others
      function unitSelector(e) {
        //set Units header
        document.getElementById("unit-header").innerText = e.target.innerText;

        //set sibling ul class to not hidden (expanded)
        let list = getElementSiblings(e.target, "ul");
        list.forEach((element) => element.classList.remove("collapse"));

        //set parent li siblings ul class to hidden
        let listSiblings = getElementSiblings(e.target.parentElement, "li");
        listSiblings.forEach((li) => {
          for (let i = 0; i < li.getElementsByTagName("ul").length; i++) {
            li.getElementsByTagName("ul")[i].classList.add("collapse");
          }
        });
      }

      // Array.from(document.getElementsByClassName("unit-selector")).forEach(
      //   (element) => {
      //     element.addEventListener("click", unitSelector);
      //   }
      // );

      function calcSelector(event) {
        let key = event.target.id;
        let functionMap = new Map(Object.entries(JSON.parse(sessionStorage.getItem("functionMap"))));
        let functionElement = functionMap.get(key);

        if (functionElement) {
          document.getElementById("conversion-header").innerText =
          `${functionElement.sourceUnit} to ${functionElement.targetUnit}`;  
          // event.target.innerText;
          document
            .getElementById("convert-from")
            .setAttribute(
              "data-conversion-function",
              functionElement.functionName
            );
          document
            .getElementById("convert-to")
            .setAttribute(
              "data-conversion-function",
              functionElement.converseFunctionName
            );
          document.getElementById("th-from").innerText =
            functionElement.sourceUnit;
          document.getElementById("th-to").innerText =
            functionElement.targetUnit;
          document.getElementById("formula").innerText =
            functionElement.formula;
        }

        //and execute function on existing data
        document.getElementById("convert-to").value = window[
          document
            .getElementById("convert-from")
            .getAttribute("data-conversion-function")
        ](document.getElementById("convert-from").value);
      }

      //delegated function to initialise conversion factor data on calc-select
      document.getElementById("conversion-selector-list").addEventListener(
        "click",
        (event) => {
          if (event.target.classList.contains("unit-selector")) {
            unitSelector(event);
          } else if (event.target.classList.contains("calc-selector")) {
            calcSelector(event);
          }
        },
        true
      );

      //Only accept numbers (including - and decimals) - reject all other keypresses
      //todo - strip leading zero if relevant
      document
        .getElementById("convert-from")
        .addEventListener("keypress", (event) => {
          const pattern = /^-{0,1}\d*\.{0,1}\d*$/;
          let start = event.target.selectionStart;
          let end = event.target.selectionEnd;
          let text = event.target.value;
          let startText = text.substr(0, start);
          let selectedText = text.substr(start, end - start);
          let endText = text.substr(end);

          if (!pattern.test(startText + event.key + endText)) {
            event.preventDefault();
          }
        });

      //perform conversion function on value change
      document
        .getElementById("convert-from")
        .addEventListener("keyup", (event) => {
          document.getElementById("convert-to").value = window[
            event.target.getAttribute("data-conversion-function")
          ](event.target.value);
        });
    </script>
  </body>
</html>
